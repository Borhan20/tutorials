# How Networks Work #
1. Network structure, it's basic components, how they are used in practice with the help of VMs and libvirt/KVM

## OSI Model ##
1. [OSI Model](https://en.wikipedia.org/wiki/OSI_model)
	1. The model standardizes communication between network protocols
	2. Divides communication into 7 layers
		1. Each layer has it's own set of protocols
2. 7 Layers:
	1. Physical layer
	2. Data Link layer
	3. Network layer
	4. Transport layer
	5. Session layer
	6. Presentation layer
	7. Application layer

### Physical Layer ###
1. Protocols are responsible for hardware communication on lowest level
	1. Transmission of data by wire (or wireless) is described in the layer
	2. Examples:
		1. Wi-Fi
		2. Bluetooth
		3. DSL

### Data Link Layer ###
1. Responsible for transmission of data between two devices in one network
	1. Transmitted in frames
		1. Frame: contains physical address of sender and receiver
			1. MAC-address
	2. Who are sender and receiver?
		1. Every device has NIC (Network Interface Controller)
			1. It is hardware (or virtual hardware) responsible from sending and receiving frames
			2. NIC has a MAC address
				1. MAC address - unique address embedded in hardware or generated by Virtual system
			3. A machine can have multiple NICs
	3. How to check NICs in a system?
		1. `ip link show` **(M)**
	4. Interface for communicating is eth0
		1. MAC address: 52:54:00:05:36:e6
		2. `lo`? loopback device
			1. It is a virtual interface which is used by system to communicate with itself
				1. Local apps can communicate with each other without internet
2. Other connecting devices:
	1. Switch
		1. It builds up a network
			1. All machines are connected to it via ports
				1. L2 switch (more advanced ones exist - L3 and L7)
					1. It forwards frames to MAC sender to MAC receiver
		2. Devices connected to a switch form a LAN (Local Area Network)
			1. [LAN](https://en.wikipedia.org/wiki/Local_area_network)
		3. Used to connect servers located physically in the same place
			1. All the servers will belong to the same network
	2. VLAN (virtual local area network):
		1. Can be implemented using switch
			1. VLAN-tag is added to frame
				1. It determines which network of the frame it belongs to
	3. Bridge:
		1. L2 bridge - used to connect two networks (formed using switches)
			1. Switches, bridges and hubs connect multiple devices together into one network
	4. Routers:
		1. Work on L3
			1. Wi-Fi router connects local area network (which has laptop, mobile phone, tablet) with the internet
3. WAN: Wide Area Network
	1. Internet is a WAN but erases geographical boundaries of network
		1. [L3 switches](https://dougvitale.wordpress.com/2012/12/01/layer-3-switches-compared-to-routers/) may have routing capabilities

### Network Layer ###
1. On third network layer: IP addresses are used instead of MAC addresses
	1. `ip addr show` **(M)**
		1. IP address assigned to eth0
			1. `/24`: Internet is many networks together
				1. Each network has a [separate block of IP addresses](https://en.wikipedia.org/wiki/Reserved_IP_addresses)
					1. Example private networks not accessible from outside
			2. CIDR: A method to allocate IP addresses for networks
				1. Notation: 192.168.122.212/24
					1. `/24`: Mask - defines how many addresses are in the block
						1. IP addresses go from 0.0.0.0 to 255.255.255.255 (32 bits number)
						2. Mask: 255.255.255.0
						3. Finding first and last address of the network:
							1. Do bitwise AND of one of the addresses and the mask

									11000000.10101000.01111010.11010100
									&
									11111111.11111111.11111111.00000000
									=
									11000000.10101000.01111010.00000000

								1. 192.168.122.0 is starting address of the network
								2. 192.168.122.255 is ending address of the network
									1. 255 addresses in total [calculator](https://www.iplocation.net/subnet-calculator)

### ARP ###
1. [ARP (Address Resolution Protocol)](https://en.wikipedia.org/wiki/Address_Resolution_Protocol) - A mechanism that associates MAC-address with IP-address
	1. `arp -n` table of MAC addresses and IP addresses mapped to them
		1. `ip neigh` is preferred
	2. Cyber attack: [ARP spoofing](https://en.wikipedia.org/wiki/ARP_spoofing)
		1. Replaces MAC-address with hacker's device address

### DHCP ###
1. Two options for assigning IP address
	1. Manual: hadwork (there may be conflicts)
	2. Dynamic Host Configuration Protocol ([DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol))
		1. Protocol for setting different configurations including IP-addresses automatically
	3. DHCP server: assigns IP-addresses
		1. At home DHCP server is located in router
	4. DHCP client: On the device - requests for an address
		1. DHCP client is located in each device
2. How does DHCP work?
	1. [broadcasting](https://en.wikipedia.org/wiki/Broadcasting_%28networking%29)
		1. Process by which server transfers a message to all servers in network as it doesn't know where exactly the info it needs is located
	2. Steps:
		1. A DHCP-client sends a bradcast message with a request "I need an IP-address"
			1. Sender field of packet is set to 0.0.0.0 and UDP port 68 (reserved for DHCP clients)
			2. Receiver field of packet is set to 255.255.255.255, UDP port 67 (reserved for DHCP servers)
				1. Broadcasts to everyone in the network
		2. A DHCP-server catches it and sends back a broadcast message "I have an IP-address x.x.x.x, do you want it? (for certain amount of time)"
			1. We don't know how to find the host
			2. IP sender - 192.168.1.1, UDP port 67
			3. IP receiver - 255.255.255.255, UDP port 68 - broadcast
		3. The DHCP-client receives the message and sends another one: "Yes, I want the address x.x.x.x"
			1. IP sender 0.0.0.0, UDP port 68
			2. IP receiver: 255.255.255.255, UDP port 67 - broadcast
		4. The DHCP-server answers "OK, then x.x.x.x belongs to you"
			1. IP sender: 192.168.1.1, UDP port 67
			2. IP receiver: 255.255.255.255, UDP port 68 - broadcast
	3. Video:
		1. [https://www.youtube.com/watch?v=RUZohsAxPxQ](https://www.youtube.com/watch?v=RUZohsAxPxQ)
			1. If multiple servers can respond with an address offer
				1. New host chooses one offer
				1. Servers see which offer the client picked
			2. Two hosts can ask for an address simultaneously
				1. Can be distinguished using **transaction ID**
			3. Addresses are valid for a limited time
				1. This mechanism is used to re-cycle the un-used IP addresses so that others can use them again
				2. Hosts can prevent the server from taking away the IP addresses by renewing the lease
	4. Where are the connection settings stored?
		1. `/etc/sysconfig/network-scripts` **(M)**
			1. We can edit the way IP-address is assigned (static or automatic)
			2. Whether to start connection automatically when system loads or not
		2. Example:

				HWADDR=4C:34:88:54:C1:2B
				ESSID="FRITX!Box 7490"
				MODE=Managed
				KEY_MGMT=WPA-PSK
				TYPE=Wireless
				BOOTPROTO=dhcp
				DEFROUTE=yes
				IPV4_FAILURE_FATAL=no
				IPV6INIT=yes
				IPV6_AUTOCONF=yes
				IPV6_DEFROUTE=yes
				IPV6_FAILURE_FATAL=no
				NAME="FRITZ!Box 7490"
				UUID=55ba9218-1d2f-407d-af13-51502d542edb
				ONBOOT=yes
				SECURITYMODE=open
				PEERDNS=yes
				PEERROUTES=yes
				IPV6_PEERDNS=yes
				IPV6_PEERROUTES=yes

			1. `BOOTPROTO=dhcp` - says that the device uses DHCP to receive IP address
		3. Example - for loopback device

				DEVICE=lo
				IPADDR=127.0.0.1
				NETMASK=255.0.0.0
				NETWORK=127.0.0.0
				# If you're having problems with gated making 127.0.0.0/8 a martian,
				# you can change this to something else (255.255.255.255, for example)
				BROADCAST=127.255.255.255
				ONBOOT=yes
				NAME=loopback

			1. `IPADDR=127.0.0.1` - static address
		3. `nmcli` or `Networkmanager-tui` package for friendly text interface to modify the settings
			1. On servers: use system of configuration (Puppet, Chef, Salt)

### DNS ###
### Virtual Machines ###
### NAT ###
### tcpdump ###
### VPN ###
### For Self Study ###
### What's Next? ###
### Further Reading ###
